[
  {
    "$match": {
      "country_code": {
        "$ne": null
      },
      "power_kw": {
        "$gte": 50
      }
    }
  },
  {
    "$addFields": {
      "charging_category": {
        "$switch": {
          "branches": [
            {
              "case": {
                "$gte": [
                  "$power_kw",
                  350
                ]
              },
              "then": "Ultra Fast (350kW+)"
            },
            {
              "case": {
                "$gte": [
                  "$power_kw",
                  150
                ]
              },
              "then": "Super Fast (150-349kW)"
            },
            {
              "case": {
                "$gte": [
                  "$power_kw",
                  50
                ]
              },
              "then": "Fast (50-149kW)"
            }
          ],
          "default": "Standard"
        }
      }
    }
  },
  {
    "$group": {
      "_id": {
        "country": "$country_code",
        "category": "$charging_category"
      },
      "station_count": {
        "$sum": 1
      },
      "total_ports": {
        "$sum": "$ports"
      },
      "operators": {
        "$addToSet": "$operator_name"
      }
    }
  },
  {
    "$addFields": {
      "operator_count": {
        "$size": "$operators"
      },
      "avg_ports_per_station": {
        "$divide": [
          "$total_ports",
          {
            "$max": [
              "$station_count",
              1
            ]
          }
        ]
      }
    }
  },
  {
    "$sort": {
      "_id.category": 1,
      "station_count": -1
    }
  },
  {
    "$project": {
      "_id": 0,
      "country_code": "$_id.country",
      "charging_category": "$_id.category",
      "station_count": 1,
      "total_ports": 1,
      "operator_count": 1,
      "avg_ports_per_station": {
        "$round": [
          "$avg_ports_per_station",
          1
        ]
      }
    }
  }
]